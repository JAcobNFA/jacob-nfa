<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Jacob â€” Verify Wallet</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--tg-theme-bg-color, #1a1a2e);
    color: var(--tg-theme-text-color, #e0e0e0);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 20px 40px;
  }
  .logo { width: 64px; height: 64px; border-radius: 50%; margin: 8px 0 12px; }
  h1 { font-size: 20px; margin-bottom: 4px; text-align: center; }
  .subtitle { font-size: 13px; opacity: 0.6; margin-bottom: 24px; text-align: center; max-width: 300px; line-height: 1.4; }

  .section { width: 100%; max-width: 360px; margin-bottom: 18px; }
  .section-label { font-size: 13px; font-weight: 600; opacity: 0.5; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }

  .input-wrap {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.12);
    border-radius: 14px; padding: 4px;
    transition: border-color 0.2s;
  }
  .input-wrap.focused { border-color: #00d4aa; }
  .input-wrap.valid { border-color: #00d4aa; }
  .input-wrap.invalid { border-color: #ff5050; }
  .input-wrap input, .input-wrap textarea {
    width: 100%; padding: 14px 12px;
    background: transparent; border: none;
    color: inherit; font-size: 14px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    outline: none; letter-spacing: 0.2px;
    resize: none;
  }
  .input-wrap input::placeholder, .input-wrap textarea::placeholder { opacity: 0.3; font-family: -apple-system, sans-serif; }

  .step-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px; padding: 16px;
    margin-bottom: 12px;
  }
  .step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .step-num {
    width: 26px; height: 26px; min-width: 26px;
    border-radius: 50%;
    background: rgba(0,212,170,0.15); color: #00d4aa;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700;
  }
  .step-num.done { background: #00d4aa; color: #000; }
  .step-title { font-size: 15px; font-weight: 600; }
  .step-desc { font-size: 13px; opacity: 0.6; line-height: 1.4; margin-bottom: 10px; }

  .msg-box {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; padding: 12px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px; line-height: 1.5;
    word-break: break-all;
    position: relative;
    margin-bottom: 8px;
  }

  .copy-btn, .small-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 14px; border-radius: 10px;
    border: 1px solid rgba(0,212,170,0.3);
    background: rgba(0,212,170,0.1);
    color: #00d4aa; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
  }
  .copy-btn:active, .small-btn:active { transform: scale(0.96); background: rgba(0,212,170,0.2); }

  .primary-btn {
    width: 100%; padding: 16px; border-radius: 14px;
    border: none; background: #00d4aa; color: #000;
    font-weight: 700; font-size: 16px;
    cursor: pointer; margin-top: 6px;
    transition: all 0.2s;
  }
  .primary-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .primary-btn:not(:disabled):active { transform: scale(0.97); }

  .status {
    margin-top: 14px; padding: 14px 16px;
    border-radius: 12px;
    width: 100%; max-width: 360px;
    text-align: center; font-size: 14px;
    display: none;
  }
  .status.success { display: block; background: rgba(0,212,170,0.15); color: #00d4aa; border: 1px solid rgba(0,212,170,0.3); }
  .status.error { display: block; background: rgba(255,80,80,0.15); color: #ff5050; border: 1px solid rgba(255,80,80,0.3); }
  .status.loading { display: block; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); }

  .note { margin-top: 16px; font-size: 11px; opacity: 0.35; text-align: center; max-width: 320px; line-height: 1.5; }
  .hidden { display: none !important; }

  .paste-row { display: flex; gap: 8px; margin-top: 8px; }
  .paste-row .small-btn { flex: 1; justify-content: center; }

  .how-link {
    display: block; text-align: center;
    margin-top: 10px; font-size: 12px;
    color: #00d4aa; opacity: 0.7;
    cursor: pointer; text-decoration: underline;
  }
  .how-content {
    margin-top: 10px; font-size: 12px; line-height: 1.6;
    opacity: 0.6; padding: 12px;
    background: rgba(0,0,0,0.2); border-radius: 10px;
  }
  .how-content strong { color: #00d4aa; opacity: 1; }
</style>
</head>
<body>
  <img src="/images/jacob-token-logo.png" class="logo" alt="Jacob">
  <h1>Verify Your Wallet</h1>
  <p class="subtitle">Sign a message to prove you own this wallet. Your private key is never shared.</p>

  <div class="step-card" id="step1">
    <div class="step-header">
      <div class="step-num" id="step1-num">1</div>
      <div class="step-title">Enter Your Address</div>
    </div>
    <div class="step-desc">Paste your BSC wallet address</div>
    <div class="input-wrap" id="addr-wrap">
      <input type="text" id="addr-input" placeholder="0x..." maxlength="42" autocomplete="off" spellcheck="false" autocapitalize="off">
    </div>
    <div class="paste-row">
      <div class="small-btn" onclick="pasteAddr()">&#x1F4CB; Paste</div>
    </div>
    <button class="primary-btn" id="gen-btn" onclick="generateChallenge()" disabled style="margin-top:12px">Next: Generate Verification Message</button>
  </div>

  <div class="step-card hidden" id="step2">
    <div class="step-header">
      <div class="step-num" id="step2-num">2</div>
      <div class="step-title">Sign This Message</div>
    </div>
    <div class="step-desc">Copy the message below, open your wallet app, and use "Sign Message" to sign it.</div>
    <div class="msg-box" id="challenge-msg"></div>
    <div class="copy-btn" onclick="copyChallenge()">&#x1F4CB; Copy Message</div>
    <span class="how-link" onclick="toggleHow()">How do I sign a message?</span>
    <div class="how-content hidden" id="how-section">
      <strong>MetaMask:</strong> Settings &gt; Experimental &gt; Sign message<br>
      <strong>Trust Wallet:</strong> DApp browser &gt; use a signing tool like etherscan.io/verifiedSignatures<br>
      <strong>Any wallet:</strong> Visit <strong>bscscan.com/verifiedSignatures</strong>, connect wallet, click "Sign Message", paste the message, and sign. Then copy the signature.
    </div>
  </div>

  <div class="step-card hidden" id="step3">
    <div class="step-header">
      <div class="step-num" id="step3-num">3</div>
      <div class="step-title">Paste Your Signature</div>
    </div>
    <div class="step-desc">After signing, paste the signature here</div>
    <div class="input-wrap" id="sig-wrap">
      <textarea id="sig-input" placeholder="0x..." rows="3" autocomplete="off" spellcheck="false"></textarea>
    </div>
    <div class="paste-row">
      <div class="small-btn" onclick="pasteSig()">&#x1F4CB; Paste Signature</div>
    </div>
    <button class="primary-btn" id="verify-btn" onclick="verifyAndLink()" disabled style="margin-top:12px">Verify &amp; Link Wallet</button>
  </div>

  <div class="status" id="status"></div>
  <p class="note">This proves you own the wallet without sharing your private key.<br>Jacob never asks for seed phrases.</p>

<script>
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) tg.expand();

const addrInput = document.getElementById('addr-input');
const addrWrap = document.getElementById('addr-wrap');
const genBtn = document.getElementById('gen-btn');
const sigInput = document.getElementById('sig-input');
const sigWrap = document.getElementById('sig-wrap');
const verifyBtn = document.getElementById('verify-btn');
const statusEl = document.getElementById('status');
const challengeBox = document.getElementById('challenge-msg');

let challengeText = '';
let nonce = '';

addrInput.addEventListener('focus', () => addrWrap.classList.add('focused'));
addrInput.addEventListener('blur', () => addrWrap.classList.remove('focused'));
sigInput.addEventListener('focus', () => sigWrap.classList.add('focused'));
sigInput.addEventListener('blur', () => sigWrap.classList.remove('focused'));

addrInput.addEventListener('input', () => {
  const v = addrInput.value.trim();
  const valid = /^0x[a-fA-F0-9]{40}$/.test(v);
  genBtn.disabled = !valid;
  addrWrap.classList.toggle('valid', valid);
  addrWrap.classList.toggle('invalid', v.length >= 5 && !valid);
});

sigInput.addEventListener('input', () => {
  const v = sigInput.value.trim();
  const valid = /^0x[a-fA-F0-9]{130}$/.test(v);
  verifyBtn.disabled = !valid;
  sigWrap.classList.toggle('valid', valid);
});

async function pasteAddr() {
  try {
    const t = await navigator.clipboard.readText();
    if (t) { addrInput.value = t.trim(); addrInput.dispatchEvent(new Event('input')); }
  } catch(e) { addrInput.focus(); }
}

async function pasteSig() {
  try {
    const t = await navigator.clipboard.readText();
    if (t) { sigInput.value = t.trim(); sigInput.dispatchEvent(new Event('input')); }
  } catch(e) { sigInput.focus(); }
}

function showStatus(msg, type) {
  statusEl.textContent = msg;
  statusEl.className = 'status ' + type;
}

async function generateChallenge() {
  const addr = addrInput.value.trim();
  if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) return;

  const chatId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user
    ? tg.initDataUnsafe.user.id : null;
  if (!chatId) {
    showStatus('Could not identify your Telegram account.', 'error');
    return;
  }

  genBtn.disabled = true;
  genBtn.textContent = 'Generating...';

  try {
    const resp = await fetch('/api/tg-wallet-nonce', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatId, address: addr })
    });
    const data = await resp.json();
    if (!data.nonce || !data.message) throw new Error(data.error || 'Failed to get challenge');

    nonce = data.nonce;
    challengeText = data.message;
    challengeBox.textContent = challengeText;

    document.getElementById('step1-num').classList.add('done');
    document.getElementById('step1-num').textContent = '\u2713';
    addrInput.disabled = true;
    genBtn.classList.add('hidden');

    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('step3').classList.remove('hidden');
  } catch (e) {
    showStatus(e.message || 'Failed to generate challenge', 'error');
    genBtn.disabled = false;
    genBtn.textContent = 'Generate Challenge';
  }
}

function copyChallenge() {
  navigator.clipboard.writeText(challengeText).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '\u2705 Copied!';
    setTimeout(() => { btn.innerHTML = '&#x1F4CB; Copy Message'; }, 2000);
  }).catch(() => {
    showStatus('Long-press the message box to select and copy', 'error');
    setTimeout(() => { statusEl.className = 'status'; }, 3000);
  });
}

function toggleHow() {
  document.getElementById('how-section').classList.toggle('hidden');
}

async function verifyAndLink() {
  const address = addrInput.value.trim().toLowerCase();
  const signature = sigInput.value.trim();

  if (!/^0x[a-fA-F0-9]{40}$/.test(address) || !signature) return;

  const chatId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user
    ? tg.initDataUnsafe.user.id : null;

  if (!chatId) {
    showStatus('Could not identify your Telegram account. Try pasting your address directly in the bot chat.', 'error');
    return;
  }

  verifyBtn.disabled = true;
  verifyBtn.textContent = 'Verifying...';
  showStatus('Verifying signature on-chain...', 'loading');

  try {
    const resp = await fetch('/api/tg-link-wallet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatId, address, signature, message: challengeText })
    });
    const result = await resp.json();
    if (result.success) {
      document.getElementById('step2-num').classList.add('done');
      document.getElementById('step2-num').textContent = '\u2713';
      document.getElementById('step3-num').classList.add('done');
      document.getElementById('step3-num').textContent = '\u2713';
      showStatus('\u2705 Wallet verified and linked!', 'success');
      if (tg) setTimeout(() => { tg.close(); }, 1500);
    } else {
      throw new Error(result.error || 'Verification failed');
    }
  } catch (e) {
    showStatus(e.message || 'Verification failed. Check your signature and try again.', 'error');
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'Verify & Link Wallet';
  }
}

addrInput.focus();
</script>
</body>
</html>
